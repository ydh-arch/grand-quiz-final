<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Grand Quiz - Client</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --gb-pink: #F7CAC9; --gb-purple: #5D3A5D; --gb-gold: #D4AF37; }
        body { background-color: var(--gb-pink); color: var(--gb-purple); font-family: 'GmarketSansMedium', sans-serif; margin: 0; padding: 20px; text-align: center; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; }
        .active { display: flex; }

        h1, h2 { margin: 10px 0; }
        
        input { padding: 15px; font-size: 1.5rem; border-radius: 15px; border: 3px solid var(--gb-purple); width: 80%; text-align: center; margin-bottom: 20px; outline: none; }
        .btn { padding: 15px 30px; background: var(--gb-purple); color: white; border: none; font-size: 1.5rem; border-radius: 50px; cursor: pointer; width: 80%; max-width: 300px; margin-bottom: 10px; font-weight: bold; box-shadow: 0 5px 0 #3e263e; transition: 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #3e263e; }

        /* ì„ íƒì§€ ê·¸ë¦¬ë“œ */
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; height: 60%; max-height: 500px; }
        .opt-btn { width: 100%; height: 100%; font-size: 3rem; border-radius: 20px; border: 4px solid rgba(0,0,0,0.1); color: white; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .opt-btn:active { transform: scale(0.95); }
        
        /* ê²°ê³¼ íŒì—… (ì •ë‹µ/ì˜¤ë‹µ) */
        .result-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .result-icon { font-size: 8rem; margin-bottom: 20px; }
        .score-box { background: rgba(255,255,255,0.2); padding: 15px 30px; border-radius: 15px; margin-top: 20px; text-align: center; }
    </style>
</head>
<body>
    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="screen active">
        <h1 style="font-size:2.5rem; margin-bottom:10px;">ğŸ¨ The Grand Quiz</h1>
        <p style="margin-bottom:30px; font-size:1.2rem;">ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì…ì¥í•˜ì„¸ìš”</p>
        <input type="text" id="username" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: ì œì„ìŠ¤)" maxlength="8">
        <button class="btn" onclick="joinGame()">ì…ì¥í•˜ê¸°</button>
    </div>

    <!-- 2. ëŒ€ê¸° í™”ë©´ -->
    <div id="wait-screen" class="screen">
        <div style="font-size:4rem; margin-bottom:20px;">â³</div>
        <h2 style="font-size:2rem;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</h2>
        <p>í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.</p>
        <div id="my-name-display" style="margin-top:20px; font-weight:bold; color:var(--gb-gold); font-size:1.5rem;"></div>
    </div>

    <!-- 3. ë¬¸ì œ í’€ê¸° í™”ë©´ -->
    <div id="play-screen" class="screen">
        <!-- ì£¼ê´€ì‹/ìˆœì„œ -->
        <div id="input-area" style="width:100%; display:none; flex-direction:column; align-items:center;">
            <h2 id="input-guide" style="margin-bottom:20px;">ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”</h2>
            <input type="text" id="answer-input" placeholder="ì •ë‹µ ì…ë ¥">
            <button class="btn" onclick="submitAnswer()">ì œì¶œí•˜ê¸°</button>
        </div>
        
        <!-- 4ì§€ì„ ë‹¤ -->
        <div id="choice-area" class="grid-options" style="display:none;">
            <button class="opt-btn" style="background:#E74C3C" onclick="submitChoice(0)">â–²</button>
            <button class="opt-btn" style="background:#3498DB" onclick="submitChoice(1)">â– </button>
            <button class="opt-btn" style="background:#F1C40F; color:black;" onclick="submitChoice(2)">â—</button>
            <button class="opt-btn" style="background:#2ECC71" onclick="submitChoice(3)">â—†</button>
        </div>

        <!-- OX -->
        <div id="ox-area" class="grid-options" style="display:none;">
            <button class="opt-btn" style="background:#E74C3C" onclick="submitChoice('O')">O</button>
            <button class="opt-btn" style="background:#3498DB" onclick="submitChoice('X')">X</button>
        </div>
        
        <!-- ì œì¶œ ì™„ë£Œ ë©”ì‹œì§€ -->
        <div id="submitted-msg" style="display:none;">
            <div style="font-size:4rem;">ğŸ“¨</div>
            <h2 style="color:var(--gb-purple);">ì œì¶œ ì™„ë£Œ!</h2>
            <p>ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- 4. ê²°ê³¼ ì˜¤ë²„ë ˆì´ (ì •ë‹µ/ì˜¤ë‹µ/ì ìˆ˜) -->
    <div id="result-overlay" class="result-popup">
        <div id="res-icon" class="result-icon">â­•</div>
        <h1 id="res-text" style="font-size:3rem; margin:0;">ì •ë‹µ!</h1>
        
        <div class="score-box">
            <div style="font-size:1rem; opacity:0.8;">íšë“ ì ìˆ˜</div>
            <div style="font-size:2.5rem; font-weight:bold; color:var(--gb-gold);">+<span id="res-earned">0</span></div>
        </div>
        
        <div style="margin-top:20px; font-size:1.2rem;">
            í˜„ì¬ ì´ì : <span id="res-total" style="font-weight:bold;">0</span>ì 
        </div>
    </div>

    <script>
        // â˜… í˜¸ìŠ¤íŠ¸ì™€ ë™ì¼í•œ Firebase ì„¤ì • ë¶™ì—¬ë„£ê¸° í•„ìˆ˜!
        const firebaseConfig = {
            apiKey: "ì—¬ê¸°ì—_API_KEY_ì…ë ¥",
            authDomain: "ì—¬ê¸°ì—_AUTH_DOMAIN_ì…ë ¥",
            databaseURL: "ì—¬ê¸°ì—_DATABASE_URL_ì…ë ¥",
            projectId: "ì—¬ê¸°ì—_PROJECT_ID_ì…ë ¥",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        // ì„¤ì •ì´ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
        if (firebaseConfig.apiKey.includes("ì—¬ê¸°ì—")) {
            alert("ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš” (Firebase ì„¤ì • ë¯¸ì™„ë£Œ)");
        } else {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        let myId = localStorage.getItem('grand_quiz_uid');
        if(!myId) {
            myId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('grand_quiz_uid', myId);
        }

        // 1. ê²Œì„ ìƒíƒœ ê°ì§€ (ë¡œë¹„ / í”Œë ˆì´ / ëŒ€ê¸°)
        db.ref('gameStatus').on('value', snap => {
            const status = snap.val();
            if(!status) return; // ë°ì´í„° ì—†ìœ¼ë©´ ëŒ€ê¸°

            // ë¡œë¹„ (ëŒ€ê¸°ì‹¤)
            if(status.state === 'lobby') {
                const savedName = localStorage.getItem('grand_quiz_name');
                if(savedName) {
                    showScreen('wait-screen');
                    document.getElementById('my-name-display').innerText = `ì°¸ê°€ì: ${savedName}`;
                } else {
                    showScreen('login-screen');
                }
                document.getElementById('result-overlay').style.display = 'none'; // ê²°ê³¼ì°½ ë„ê¸°
            } 
            // ë¬¸ì œ í’€ê¸°
            else if(status.state === 'play') {
                setupQuestion(status.type);
                showScreen('play-screen');
                document.getElementById('result-overlay').style.display = 'none'; // ìƒˆ ë¬¸ì œ ë‚˜ì˜¤ë©´ ê²°ê³¼ì°½ ë„ê¸°
            } 
            // ì •ë‹µ í™•ì¸ ì¤‘ (ê²°ê³¼ í™”ë©´ì€ ë³„ë„ ë¦¬ìŠ¤ë„ˆë¡œ ëœ¸)
            else if(status.state === 'wait') {
                // ì´ë¯¸ ì œì¶œí–ˆê±°ë‚˜ ì‹œê°„ì´ ëë‚¬ìœ¼ë©´ ëŒ€ê¸° í™”ë©´
                if(document.getElementById('result-overlay').style.display === 'none') {
                    showScreen('wait-screen');
                }
            }
        });

        // 2. ë‚´ ì ìˆ˜/ê²°ê³¼ ê°ì§€ (í˜¸ìŠ¤íŠ¸ê°€ ì •ë‹µ ëˆ„ë¥´ë©´ ëœ¸)
        db.ref(`players/${myId}/lastResult`).on('value', snap => {
            const res = snap.val();
            // í˜¸ìŠ¤íŠ¸ê°€ gameStatusë¥¼ waitë¡œ ë°”ê¿¨ì„ ë•Œë§Œ ê²°ê³¼ë¥¼ ë„ì›€
            db.ref('gameStatus/state').once('value', sSnap => {
                if(sSnap.val() === 'wait' && res) {
                    showResultPopup(res);
                }
            });
        });

        function showResultPopup(res) {
            const overlay = document.getElementById('result-overlay');
            const icon = document.getElementById('res-icon');
            const text = document.getElementById('res-text');
            
            if(res.isCorrect) {
                icon.innerText = "â­•";
                text.innerText = "ì •ë‹µ!";
                text.style.color = "#2ECC71";
            } else {
                icon.innerText = "âŒ";
                text.innerText = "ë•¡!";
                text.style.color = "#E74C3C";
            }
            document.getElementById('res-earned').innerText = res.earned;
            document.getElementById('res-total').innerText = res.total;
            
            overlay.style.display = 'flex';
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function joinGame() {
            const name = document.getElementById('username').value.trim();
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
            
            localStorage.setItem('grand_quiz_name', name);
            
            // ì°¸ê°€ì ë“±ë¡ (ê¸°ì¡´ ì ìˆ˜ ìœ ì§€ ìœ„í•´ update ì‚¬ìš© ê¶Œì¥)
            db.ref(`players/${myId}`).update({ 
                name: name,
                // ì ìˆ˜ëŠ” ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (ì¬ì ‘ì† ì‹œ ìœ ì§€)
            });
            
            showScreen('wait-screen');
            document.getElementById('my-name-display').innerText = `ì°¸ê°€ì: ${name}`;
        }

        function setupQuestion(type) {
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('choice-area').style.display = 'none';
            document.getElementById('ox-area').style.display = 'none';
            document.getElementById('submitted-msg').style.display = 'none';
            document.getElementById('answer-input').value = "";

            if(type === 'choice') document.getElementById('choice-area').style.display = 'grid';
            else if(type === 'ox') document.getElementById('ox-area').style.display = 'grid';
            else {
                document.getElementById('input-area').style.display = 'flex';
                const guide = (type === 'order' || type === 'ìˆœì„œ') ? "ìˆœì„œëŒ€ë¡œ ì…ë ¥ (ì˜ˆ: 1234)" : "ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
                document.getElementById('input-guide').innerText = guide;
                document.getElementById('answer-input').placeholder = "í„°ì¹˜í•˜ì—¬ ì…ë ¥";
            }
        }

        function submitChoice(val) {
            db.ref(`answers/${myId}`).set({ answer: val, time: Date.now() });
            showSubmitted();
        }

        function submitAnswer() {
            const val = document.getElementById('answer-input').value.trim();
            if(!val) return alert("ë‹µì„ ì…ë ¥í•˜ì„¸ìš”");
            db.ref(`answers/${myId}`).set({ answer: val, time: Date.now() });
            showSubmitted();
        }

        function showSubmitted() {
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('choice-area').style.display = 'none';
            document.getElementById('ox-area').style.display = 'none';
            document.getElementById('submitted-msg').style.display = 'block';
        }
    </script>
</body>
</html>
