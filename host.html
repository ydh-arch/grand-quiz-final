<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>The Grand Quiz - Host</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gb-pink: #F7CAC9; --gb-purple: #5D3A5D; --gb-gold: #D4AF37; --gb-red: #C0392B; }
        body { background-color: var(--gb-pink); color: var(--gb-purple); font-family: 'GmarketSansMedium', sans-serif; margin: 0; text-align: center; display: flex; flex-direction: column; height: 100vh; }
        .header { background: var(--gb-purple); color: #fff; padding: 20px; font-size: 2rem; border-bottom: 5px solid var(--gb-gold); display: flex; justify-content: space-between; align-items: center; padding-left: 40px; padding-right: 40px;}
        
        .main { flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; position: relative; }
        .screen { display: none; width: 80%; max-width: 900px; }
        .active { display: block; }

        /* QR ì˜ì—­ */
        #qr-area { background: #fff; padding: 20px; border: 4px solid var(--gb-gold); display: inline-block; min-width: 200px; min-height: 200px; }
        #qr-area img { display: block; margin: 0 auto; }

        /* ë¼ìš´ë“œ ì •ë³´ ë°°ì§€ */
        .round-badge { background: var(--gb-gold); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 1.2rem; margin-bottom: 10px; display: inline-block; font-weight: bold; }

        /* ë¬¸ì œ í™”ë©´ */
        .timer-container { width: 100%; height: 15px; background: #ddd; position: absolute; top: 0; left: 0; }
        .timer-bar { height: 100%; background: var(--gb-red); width: 100%; transition: width 1s linear; }
        .question-box { background: #fff; padding: 40px; border-radius: 10px; border: 3px solid var(--gb-gold); font-size: 2.2rem; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); word-break: keep-all; font-weight: bold; position: relative; }
        .time-badge { position: absolute; top: -30px; right: -30px; background: var(--gb-purple); color: #fff; width: 80px; height: 80px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; border: 4px solid var(--gb-gold); }

        /* ë³´ê¸° ë° ë­í‚¹ */
        .options-display { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
        .opt { padding: 25px; color: white; font-size: 1.5rem; border-radius: 15px; opacity: 0.6; transition: 0.3s; font-weight: bold; }
        .opt.reveal { opacity: 1; border: 5px solid var(--gb-gold); transform: scale(1.05); box-shadow: 0 0 20px var(--gb-gold); }
        .opt-1 { background: #E74C3C; } .opt-2 { background: #3498DB; } 
        .opt-3 { background: #F1C40F; color: black; } .opt-4 { background: #2ECC71; }

        #live-rank-box { display: none; margin-top: 20px; background: #fff; padding: 20px; border: 2px solid var(--gb-gold); border-radius: 10px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .live-rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.5rem; }
        
        /* ë¼ìš´ë“œ ì¢…ë£Œ í™”ë©´ */
        #round-screen { background: rgba(255, 255, 255, 0.9); padding: 50px; border-radius: 20px; border: 5px solid var(--gb-purple); }
        .rank-list { text-align: left; background: #fff; padding: 30px; border-radius: 15px; border: 3px solid var(--gb-gold); max-height: 500px; overflow-y: auto; }
        .rank-item { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-size: 1.3rem; }

        .btn { padding: 15px 40px; background: var(--gb-purple); color: white; border: none; font-size: 1.2rem; cursor: pointer; margin-top: 30px; border-radius: 50px; }
        .btn:hover { background: #4a2d4a; transform: scale(1.05); }
        .btn-reset { background: var(--gb-red); }
    </style>
</head>
<body>
    <div class="header">
        <span>ğŸ¨ The Grand Dev Gala</span>
        <span style="font-size:1rem;">Host Mode</span>
    </div>

    <div class="main">
        <div id="lobby-screen" class="screen active">
            <h1 style="font-size:3rem; margin-bottom:10px;">Check-In</h1>
            <div id="qr-area"></div>
            <p style="font-size:1.5rem;">QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì…ì¥í•˜ì„¸ìš”</p>
            <div style="font-size:2rem; margin-top:30px; color:var(--gb-purple); font-weight:bold;">
                ì…ì¥ê°: <span id="p-count" style="color:var(--gb-red);">0</span>ëª…
            </div>
            <button class="btn" onclick="startGame()">EVENT START ğŸ¬</button>
        </div>

        <div id="game-screen" class="screen">
            <div id="round-display" class="round-badge" style="display:none;">ROUND 1</div>
            <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
            
            <div class="question-box">
                <span id="q-text">ë¬¸ì œ ë¡œë”© ì¤‘...</span>
                <div class="time-badge" id="time-left">0</div>
            </div>
            
            <div class="options-display" id="opt-container"></div>
            
            <div id="live-rank-box">
                <h3 style="margin:0 0 10px 0; color:var(--gb-purple);">ğŸ† í˜„ì¬ ìˆœìœ„</h3>
                <div id="live-rank-list"></div>
            </div>
            
            <div style="margin-top:20px; font-size:1.2rem; color:#555;">
                ì‘ë‹µ: <span id="ans-count" style="font-weight:bold; color:var(--gb-purple);">0</span>ëª…
            </div>
            <button class="btn" id="next-btn" onclick="manualCheck()">ì •ë‹µ í™•ì¸</button>
        </div>

        <div id="round-end-screen" class="screen">
            <h1 style="font-size:3rem; color:var(--gb-purple)">ğŸ‰ ROUND ì¢…ë£Œ!</h1>
            <h3>ì´ë²ˆ ë¼ìš´ë“œ ìš°ìŠ¹ìëŠ”?</h3>
            <div class="rank-list" id="round-rank-board"></div>
            <p style="color:var(--gb-red); margin-top:20px;">* ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ ì ìˆ˜ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
            <button class="btn btn-reset" onclick="startNextRound()">ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ (ì ìˆ˜ ë¦¬ì…‹)</button>
        </div>

        <div id="result-screen" class="screen">
            <h1 style="font-size:3rem; color:var(--gb-purple)">ğŸ† ìµœì¢… ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</h1>
            <div class="rank-list" id="final-rank-board"></div>
            <button class="btn" onclick="location.reload()">ìƒˆë¡œìš´ ê²Œì„</button>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… ì„¤ì • (ë³¸ì¸ ì •ë³´ ì…ë ¥) â˜…â˜…â˜…
        const firebaseConfig = {
apiKey: "AIzaSyAQcP8fknJ_ofom4Nu1-i39j7GLks0OYks",
authDomain: "thegranddvegala.firebaseapp.com",
databaseURL: "https://thegranddvegala-default-rtdb.firebaseio.com",
projectId: "thegranddvegala",
storageBucket: "thegranddvegala.firebasestorage.app",
messagingSenderId: "980091305368",
appId: "1:980091305368:web:e247f9be81e6786888bfed",
measurementId: "G-8GL8G5NCQF"
};
        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxErU4lp6cRVaK56zFdbZuzD5IvyWfV4S8nyrTmOsjU0pNqR9bQzadoquSCroD8k2wnTg/exec";
        // ------------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let quizData = [];
        let currentQIndex = -1;
        let isAnswerChecked = false;
        let timerInterval = null;
        let questionStartTime = 0;
        let currentTimeLimit = 0;
        let currentRoundPoints = 1000; // ê¸°ë³¸ê°’

        // QRì½”ë“œ
        const clientURL = window.location.href.replace('host.html', 'client.html');
        if(clientURL) new QRCode(document.getElementById("qr-area"), { text: clientURL, width: 200, height: 200 });

        // ë°ì´í„° ë¡œë“œ
        window.onload = function() {
            if(!SHEET_URL || SHEET_URL.includes("ì—¬ê¸°ì—")) {
                alert("êµ¬ê¸€ ì‹œíŠ¸ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); 
                return;
            }
            fetch(SHEET_URL)
                .then(res => res.json())
                .then(data => {
                    quizData = data;
                    console.log("ë¬¸ì œ ë¡œë”© ì™„ë£Œ:", quizData);
                })
                .catch(err => alert("ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨! ì‹œíŠ¸ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”."));
        };

        db.ref('players').on('value', snap => document.getElementById('p-count').innerText = snap.numChildren());
        db.ref('answers').on('value', snap => document.getElementById('ans-count').innerText = snap.numChildren());

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startGame() {
            if(quizData.length === 0) return alert("ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
            showScreen('game-screen');
            nextQuestion();
        }

        function nextQuestion() {
            currentQIndex++;

            // ê²Œì„ ë ì²´í¬
            if (currentQIndex >= quizData.length) {
                finishGame('final');
                return;
            }

            const q = quizData[currentQIndex];
            
            // â˜… ë¼ìš´ë“œ ë³€ê²½ ì²´í¬ ë¡œì§
            // ì´ì „ ë¬¸ì œê°€ ìˆì—ˆê³ , í˜„ì¬ ë¬¸ì œì˜ ë¼ìš´ë“œê°€ ì´ì „ê³¼ ë‹¤ë¥´ë©´ -> ë¼ìš´ë“œ ì¢…ë£Œ í™”ë©´
            if(currentQIndex > 0) {
                const prevQ = quizData[currentQIndex - 1];
                if(q.round && prevQ.round && q.round != prevQ.round) {
                    currentQIndex--; // ì¸ë±ìŠ¤ ë˜ëŒë¦¬ê³ (ë‹¤ìŒ ë¼ìš´ë“œ ì²« ë¬¸ì œëŠ” ëŒ€ê¸°)
                    finishGame('round'); // ë¼ìš´ë“œ ì¢…ë£Œ í™”ë©´ í˜¸ì¶œ
                    return;
                }
            }

            // ë¬¸ì œ ì„¸íŒ…
            isAnswerChecked = false;
            currentTimeLimit = q.time;
            currentRoundPoints = q.point; // â˜… ë°°ì  ì ìš©
            
            // ë¼ìš´ë“œ í‘œì‹œ
            const rBadge = document.getElementById('round-display');
            if(q.round) {
                rBadge.innerText = "ROUND " + q.round + " (" + currentRoundPoints + "ì )";
                rBadge.style.display = 'inline-block';
            } else {
                rBadge.style.display = 'none';
            }

            document.getElementById('q-text').innerText = q.q;
            document.getElementById('ans-count').innerText = "0";
            document.getElementById('next-btn').innerText = "ì •ë‹µ í™•ì¸";
            document.getElementById('live-rank-box').style.display = 'none';
            document.getElementById('opt-container').style.display = 'grid';
            
            const container = document.getElementById('opt-container');
            container.innerHTML = '';
            
            if(q.type === 'choice') {
                q.options.forEach((opt, idx) => {
                    container.innerHTML += `<div class="opt opt-${idx+1}" id="opt-${idx}">${['â–²','â– ','â—','â—†'][idx]} ${opt}</div>`;
                });
            } else if(q.type === 'ox') {
                container.innerHTML = `<div class="opt opt-1" id="opt-0" style="background:#E74C3C">O</div><div class="opt opt-2" id="opt-1" style="background:#3498DB">X</div>`;
            } else {
                container.style.display = 'none'; 
                container.innerHTML = `<div style="text-align:center; width:200%; font-size:1.5rem; color:#888;">ì£¼ê´€ì‹ ì…ë ¥ ëŒ€ê¸°ì¤‘...</div>`;
            }

            db.ref('gameStatus').set({ state: 'play', type: q.type });
            db.ref('answers').remove();
            
            questionStartTime = Date.now();
            startTimer(currentTimeLimit);
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            document.getElementById('time-left').innerText = timeLeft;
            document.getElementById('timer-bar').style.width = '100%';
            document.getElementById('timer-bar').style.transition = `width ${seconds}s linear`;
            
            // íƒ€ì´ë¨¸ ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹ íŠ¸ë¦­
            setTimeout(() => { document.getElementById('timer-bar').style.width = '0%'; }, 50);

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('time-left').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(); 
                }
            }, 1000);
        }

        function manualCheck() {
            if(!isAnswerChecked) { clearInterval(timerInterval); checkAnswer(); }
            else { nextQuestion(); }
        }

        function checkAnswer() {
            if (isAnswerChecked) return;
            isAnswerChecked = true;
            document.getElementById('next-btn').innerText = "ë‹¤ìŒ ë¬¸ì œ >";
            document.getElementById('time-left').innerText = "STOP";
            db.ref('gameStatus').set({ state: 'wait' });

            const q = quizData[currentQIndex];

            // ì •ë‹µ ê³µê°œ
            if(q.type !== 'input') {
                const ansId = `opt-${q.ans}`;
                if(document.getElementById(ansId)) document.getElementById(ansId).classList.add('reveal');
            } else {
                document.getElementById('q-text').innerText += `\n\nâœ… ì •ë‹µ: ${q.ans}`;
            }

            // â˜… ì±„ì  ë¡œì§ (ë°°ì  ë°˜ì˜)
            db.ref('answers').once('value', snapshot => {
                const answers = snapshot.val() || {};
                
                for (const playerId in answers) {
                    const data = answers[playerId];
                    const playerAns = data.answer;
                    const playerTime = data.time || Date.now();

                    let isCorrect = false;
                    if(q.type === 'input') {
                        if(String(playerAns).replace(/\s/g, "") === String(q.ans).replace(/\s/g, "")) isCorrect = true;
                    } else {
                        if(String(playerAns) === String(q.ans)) isCorrect = true;
                    }

                    if(isCorrect) {
                        const timeTaken = (playerTime - questionStartTime) / 1000;
                        // ê³µì‹: (ë°°ì  ì ˆë°˜) + (ë‚˜ë¨¸ì§€ ì ˆë°˜ * ë‚¨ì€ì‹œê°„ë¹„ìœ¨)
                        // ì˜ˆ: 2000ì  ë¬¸ì œ -> ê¸°ë³¸ 1000ì  í™•ë³´ + ë¹¨ë¦¬í’€ë©´ ìµœëŒ€ 1000ì  ì¶”ê°€
                        let scoreRatio = Math.max(0, (currentTimeLimit - timeTaken) / currentTimeLimit);
                        let point = Math.round((currentRoundPoints * 0.5) + (currentRoundPoints * 0.5 * scoreRatio));

                        db.ref(`players/${playerId}/score`).transaction(score => (score || 0) + point);
                    }
                }
                setTimeout(showLiveRank, 1000);
            });
        }

        // ì‹¤ì‹œê°„ ë­í‚¹ (5ìœ„ê¹Œì§€)
        function showLiveRank() {
            db.ref('players').orderByChild('score').limitToLast(5).once('value', snapshot => {
                renderRank(snapshot, 'live-rank-list');
                document.getElementById('live-rank-box').style.display = 'block';
                document.getElementById('opt-container').style.display = 'none';
            });
        }

        // ë¼ìš´ë“œ/ìµœì¢… ì¢…ë£Œ ì²˜ë¦¬
        function finishGame(mode) {
            if(mode === 'round') {
                showScreen('round-end-screen');
                // ë¼ìš´ë“œ ë­í‚¹ í‘œì‹œ
                db.ref('players').orderByChild('score').limitToLast(10).once('value', snapshot => {
                    renderRank(snapshot, 'round-rank-board');
                });
            } else {
                showScreen('result-screen');
                // ìµœì¢… ë­í‚¹ í‘œì‹œ
                db.ref('players').orderByChild('score').limitToLast(10).once('value', snapshot => {
                    renderRank(snapshot, 'final-rank-board');
                });
            }
        }

        // â˜… ì ìˆ˜ ì´ˆê¸°í™” í›„ ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰
        function startNextRound() {
            if(!confirm("ì •ë§ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì‹œì‘í• ê¹Œìš”?")) return;

            // Firebaseì˜ ëª¨ë“  í”Œë ˆì´ì–´ ì ìˆ˜ë¥¼ 0ìœ¼ë¡œ ë¦¬ì…‹
            db.ref('players').once('value', snapshot => {
                snapshot.forEach(child => {
                    child.ref.update({ score: 0 });
                });
            }).then(() => {
                currentQIndex++; // ë©ˆì·„ë˜ ì¸ë±ìŠ¤ ë‹¤ìŒìœ¼ë¡œ ì´ë™
                showScreen('game-screen');
                nextQuestion(); // ë‹¤ìŒ ë¼ìš´ë“œ ì²« ë¬¸ì œ ì‹œì‘
            });
        }

        // ë­í‚¹ ê·¸ë¦¬ê¸° ë„ìš°ë¯¸ í•¨ìˆ˜
        function renderRank(snapshot, elementId) {
            const list = [];
            snapshot.forEach(child => list.push(child.val()));
            list.reverse();

            const board = document.getElementById(elementId);
            board.innerHTML = "";
            list.forEach((p, idx) => {
                let medal = idx < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][idx] : `${idx+1}ìœ„`;
                let style = idx === 0 ? 'color:#D4AF37; font-weight:bold;' : '';
                board.innerHTML += `<div class="rank-item" style="${style}"><span>${medal} ${p.name}</span><span>${p.score || 0}ì </span></div>`;
            });
        }
    </script>
</body>
</html>

