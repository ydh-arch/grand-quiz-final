<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>The Grand Quiz - Host</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gb-pink: #F7CAC9; --gb-purple: #5D3A5D; --gb-gold: #D4AF37; --gb-red: #C0392B; }
        body { background-color: var(--gb-pink); color: var(--gb-purple); font-family: 'GmarketSansMedium', sans-serif; margin: 0; text-align: center; display: flex; flex-direction: column; height: 100vh; }
        
        .header { background: var(--gb-purple); color: #fff; padding: 20px; font-size: 2rem; border-bottom: 5px solid var(--gb-gold); display: flex; justify-content: space-between; align-items: center; padding-left: 40px; padding-right: 40px;}
        
        .main { flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; position: relative; }
        .screen { display: none; width: 90%; max-width: 1000px; }
        .active { display: flex; flex-direction: column; align-items: center; }

        /* 1. ë©”ë‰´ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 80%; max-width: 800px; }
        .menu-btn { padding: 40px; background: var(--gb-purple); color: white; border: 4px solid var(--gb-gold); font-size: 1.8rem; cursor: pointer; border-radius: 20px; transition: 0.2s; font-weight: bold; box-shadow: 0 8px 0 #3e263e; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-btn:hover { transform: translateY(-5px); box-shadow: 0 12px 0 #3e263e; filter: brightness(1.1); }
        .menu-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #3e263e; }

        .btn-main { background: #5D3A5D; } 
        .btn-consonant { background: #8E44AD; }
        .btn-image { background: #2980B9; }
        .btn-desc { background: #27AE60; }

        /* 2. ëŒ€ê¸°ì‹¤(QR) ìŠ¤íƒ€ì¼ */
        .lobby-container { display: flex; flex-direction: column; gap: 30px; align-items: center; justify-content: center; width: 100%; }
        .qr-section { background: #fff; padding: 20px; border: 4px solid var(--gb-gold); border-radius: 10px; }
        
        /* 3. ê²Œì„ í™”ë©´ ìš”ì†Œ */
        .timer-container { width: 100%; height: 15px; background: #ddd; position: absolute; top: 0; left: 0; }
        .timer-bar { height: 100%; background: var(--gb-red); width: 100%; transition: width 1s linear; }

        .question-box { background: #fff; padding: 40px; border-radius: 10px; border: 3px solid var(--gb-gold); font-size: 2.2rem; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); word-break: keep-all; font-weight: bold; position: relative; width: 80%; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .time-badge { position: absolute; top: -30px; right: -30px; background: var(--gb-purple); color: #fff; width: 80px; height: 80px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; border: 4px solid var(--gb-gold); z-index: 10; }

        .options-display { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 80%; }
        .opt { padding: 25px; color: white; font-size: 1.5rem; border-radius: 15px; opacity: 0.6; transition: 0.3s; font-weight: bold; cursor: pointer; }
        .opt.reveal { opacity: 1; border: 5px solid var(--gb-gold); transform: scale(1.05); box-shadow: 0 0 20px var(--gb-gold); }
        .opt-1 { background: #E74C3C; } .opt-2 { background: #3498DB; } 
        .opt-3 { background: #F1C40F; color: black; } .opt-4 { background: #2ECC71; }

        .game-btn { padding: 15px 40px; background: var(--gb-purple); color: white; border: none; font-size: 1.2rem; cursor: pointer; margin-top: 30px; border-radius: 50px; }
        .round-tag { font-size: 1.2rem; background: #fff; padding: 5px 20px; border-radius: 20px; border: 2px solid var(--gb-gold); color: var(--gb-purple); font-weight: bold; margin-bottom: 15px; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; font-size: 2rem; z-index: 9999; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div>ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <div class="header">
        <span>ğŸ¨ The Grand Dev Gala</span>
        <span style="font-size:1rem;">Host Mode</span>
    </div>

    <div class="main">
        <!-- 1. ë©”ë‰´ ì„ íƒ í™”ë©´ -->
        <div id="menu-screen" class="screen active">
            <h1 style="font-size:3rem; margin-bottom:40px;">Select Quiz Round</h1>
            <div class="menu-grid">
                <div class="menu-btn btn-main" onclick="selectCategory('ë©”ì¸')">
                    <span>ğŸ¨</span>
                    <span>ë©”ì¸ í€´ì¦ˆ</span>
                </div>
                <div class="menu-btn btn-consonant" onclick="selectCategory('ììŒ')">
                    <span>ğŸ”¤</span>
                    <span>ììŒ í€´ì¦ˆ</span>
                </div>
                <div class="menu-btn btn-image" onclick="selectCategory('ì´ë¯¸ì§€')">
                    <span>ğŸ”</span>
                    <span>ì´ë¯¸ì§€ í™•ëŒ€</span>
                </div>
                <div class="menu-btn btn-desc" onclick="selectCategory('ì„¤ëª…')">
                    <span>ğŸ“¢</span>
                    <span>ì„¤ëª… í€´ì¦ˆ</span>
                </div>
            </div>
        </div>

        <!-- 2. ëŒ€ê¸°ì‹¤ í™”ë©´ -->
        <div id="lobby-screen" class="screen">
            <h1 id="lobby-title" style="font-size:2.5rem; margin-bottom:10px; color:var(--gb-purple);">Check-In</h1>
            <h3 id="lobby-subtitle" style="color:#666; margin-top:0;">ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</h3>
            
            <div class="lobby-container">
                <div class="qr-section" id="qr-area"></div>
                <p style="font-size:1.2rem;">QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì…ì¥í•˜ì„¸ìš”</p>
                <div style="font-size:2rem; color:var(--gb-purple); font-weight:bold;">
                    í˜„ì¬ ì…ì¥: <span id="p-count" style="color:var(--gb-red); font-size:3rem;">0</span>ëª…
                </div>
                <div style="display:flex; gap:20px;">
                    <button class="game-btn" onclick="backToMenu()" style="background:#888;">â¬… ë©”ë‰´ë¡œ</button>
                    <button class="game-btn" onclick="resetAllScores()" style="background:var(--gb-red);">ğŸ”„ ì ìˆ˜ ì´ˆê¸°í™”</button>
                    <button class="game-btn" onclick="startGameReal()">ê²Œì„ ì‹œì‘ ğŸ¬</button>
                </div>
            </div>
        </div>

        <!-- 3. ê²Œì„ ì§„í–‰ í™”ë©´ -->
        <div id="game-screen" class="screen">
            <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
            <div class="round-tag" id="round-display">Round 1</div>

            <div class="question-box">
                <img id="q-image" src="" style="max-width:100%; max-height:300px; display:none; margin-bottom:15px; border-radius:10px;">
                <span id="q-text" style="white-space: pre-wrap;">ë¬¸ì œ ë¡œë”©ì¤‘...</span>
                <div class="time-badge" id="time-left">0</div>
                <div id="q-point-badge" style="font-size:1rem; color:#888; margin-top:15px;">ë°°ì : 1000ì </div>
            </div>
            
            <div class="options-display" id="opt-container"></div>
            
            <div id="live-rank-box" style="display:none; margin-top:20px; width:80%; background:#fff; padding:15px; border-radius:10px; border:2px solid var(--gb-gold);">
                <h3 style="margin:0 0 10px 0; color:var(--gb-purple);">ğŸ† í˜„ì¬ ìˆœìœ„ (TOP 5)</h3>
                <div id="live-rank-list"></div>
            </div>
            
            <div style="margin-top:20px; font-size:1.2rem; color:#555;">
                ì‘ë‹µ: <span id="ans-count" style="font-weight:bold; color:var(--gb-purple);">0</span>ëª…
            </div>
            <button class="game-btn" id="next-btn" onclick="manualCheck()">ì •ë‹µ í™•ì¸</button>
        </div>

        <!-- 4. ê²°ê³¼ í™”ë©´ -->
        <div id="result-screen" class="screen">
            <h1 style="font-size:3rem; color:var(--gb-purple)">ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ ğŸ†</h1>
            <div class="rank-list" id="rank-board" style="width:60%; margin:0 auto; background:#fff; padding:20px; border-radius:10px; border:3px solid var(--gb-gold); max-height:400px; overflow-y:auto;"></div>
            <button class="game-btn" onclick="backToMenu()">ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // 1. Firebase ì„¤ì • (í•„ìˆ˜!)
const firebaseConfig = {
apiKey: "AIzaSyAQcP8fknJ_ofom4Nu1-i39j7GLks0OYks",
authDomain: "thegranddvegala.firebaseapp.com",
databaseURL: "https://thegranddvegala-default-rtdb.firebaseio.com",
projectId: "thegranddvegala",
storageBucket: "thegranddvegala.firebasestorage.app",
messagingSenderId: "980091305368",
appId: "1:980091305368:web:e247f9be81e6786888bfed",
measurementId: "G-8GL8G5NCQF"
};
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. êµ¬ê¸€ ì‹œíŠ¸ ì›¹ì•± URL
        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxErU4lp6cRVaK56zFdbZuzD5IvyWfV4S8nyrTmOsjU0pNqR9bQzadoquSCroD8k2wnTg/exec";

        let allQuizData = [];
        let currentQuizList = [];
        let currentQIndex = -1;
        let isAnswerChecked = false;
        let timerInterval = null;
        let questionStartTime = 0;
        let currentTimeLimit = 0;

        const clientURL = window.location.href.replace('host.html', 'client.html');
        if(clientURL) {
            new QRCode(document.getElementById("qr-area"), { text: clientURL, width: 200, height: 200 });
        }

        window.onload = function() {
            if(!SHEET_URL || SHEET_URL.includes("ì—¬ê¸°ì—")) {
                document.getElementById('loading-overlay').style.display = 'none';
                alert("êµ¬ê¸€ ì‹œíŠ¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            fetch(SHEET_URL)
                .then(res => res.json())
                .then(data => {
                    allQuizData = data;
                    console.log("ì „ì²´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", allQuizData);
                    document.getElementById('loading-overlay').style.display = 'none';
                })
                .catch(err => {
                    console.error(err);
                    alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨.");
                    document.getElementById('loading-overlay').style.display = 'none';
                });
        };

        db.ref('players').on('value', snap => document.getElementById('p-count').innerText = snap.numChildren());
        db.ref('answers').on('value', snap => document.getElementById('ans-count').innerText = snap.numChildren());

        function selectCategory(keyword) {
            if(allQuizData.length === 0) return alert("ë°ì´í„° ë¡œë”©ì¤‘ì…ë‹ˆë‹¤.");

            const lowerKeyword = keyword.toString().toLowerCase();
            currentQuizList = allQuizData.filter(item => {
                if(!item.category) return false;
                const cat = item.category.toString().toLowerCase();
                
                if(cat.includes(lowerKeyword)) return true;
                if(lowerKeyword === 'ë©”ì¸' && cat.includes('main')) return true;
                if(lowerKeyword === 'main' && cat.includes('ë©”ì¸')) return true;
                
                return false;
            });

            if(currentQuizList.length === 0) {
                const availableCats = [...new Set(allQuizData.map(d => d.category))].join(", ");
                alert(`"${keyword}" ê´€ë ¨ ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n[í˜„ì¬ ì‹œíŠ¸ì˜ êµ¬ë¶„ ê°’ë“¤]\n${availableCats}`);
                return;
            }

            document.getElementById('lobby-title').innerText = `${keyword} í€´ì¦ˆ`;
            document.getElementById('lobby-subtitle').innerText = `ì´ ${currentQuizList.length} ë¬¸ì œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            showScreen('lobby-screen');
        }

        function startGameReal() {
            if(currentQuizList.length === 0) return;
            currentQIndex = -1;
            showScreen('game-screen');
            nextQuestion();
        }

        function backToMenu() {
            showScreen('menu-screen');
            db.ref('gameStatus').set({ state: 'lobby' });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex >= currentQuizList.length) {
                finishGame();
                return;
            }

            isAnswerChecked = false;
            const q = currentQuizList[currentQIndex];
            
            currentTimeLimit = q.time ? parseInt(q.time) : 20;
            const currentPoint = q.point ? parseInt(q.point) : 1000;
            const roundTitle = q.round ? q.round : `Q${currentQIndex+1}`;
            
            document.getElementById('round-display').innerText = `${q.category} - ${roundTitle}`;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('q-point-badge').innerText = `ë°°ì : ${currentPoint}ì `;
            
            const imgEl = document.getElementById('q-image');
            if(q.image && q.image.startsWith('http')) {
                imgEl.src = q.image;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            document.getElementById('ans-count').innerText = "0";
            document.getElementById('next-btn').innerText = "ì •ë‹µ í™•ì¸";
            document.getElementById('next-btn').disabled = false;
            document.getElementById('live-rank-box').style.display = 'none';
            document.getElementById('opt-container').style.display = 'grid';

            const container = document.getElementById('opt-container');
            container.innerHTML = '';

            // â˜… ë¬¸ì œ ìœ í˜•ë³„ ì²˜ë¦¬ (ê°ê´€ì‹, OX, ì£¼ê´€ì‹, ìˆœì„œ)
            if(q.type === 'choice') {
                q.options.forEach((opt, idx) => {
                    container.innerHTML += `<div class="opt opt-${idx+1}" id="opt-${idx}">${['â–²','â– ','â—','â—†'][idx]} ${opt}</div>`;
                });
            } else if(q.type === 'ox') {
                container.innerHTML = `
                    <div class="opt opt-1" id="opt-0" style="background:#E74C3C">O (ê·¸ë ‡ë‹¤)</div>
                    <div class="opt opt-2" id="opt-1" style="background:#3498DB">X (ì•„ë‹ˆë‹¤)</div>
                `;
            } else {
                // ì£¼ê´€ì‹ or ìˆœì„œëŒ€ë¡œ ì…ë ¥
                container.style.display = 'none';
                // â˜… ìˆœì„œ ì…ë ¥ì¼ ê²½ìš° ì•ˆë‚´ ë©˜íŠ¸ ë³€ê²½
                let guideText = "ì£¼ê´€ì‹ ë¬¸ì œì…ë‹ˆë‹¤. ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                if(q.type === 'order' || q.type === 'ìˆœì„œ') {
                    guideText = "ìˆœì„œëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 1234, ê°€ë‚˜ë‹¤ë¼)";
                }
                container.innerHTML = `<div style="text-align:center; width:200%; font-size:1.5rem; color:#888; margin-top:20px;">${guideText}</div>`;
            }

            db.ref('gameStatus').set({ state: 'play', type: q.type });
            db.ref('answers').remove();

            questionStartTime = Date.now();
            startTimer(currentTimeLimit);
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            document.getElementById('time-left').innerText = timeLeft;
            document.getElementById('timer-bar').style.width = '100%';
            document.getElementById('timer-bar').style.transition = 'none';
            setTimeout(() => {
                 document.getElementById('timer-bar').style.transition = `width ${seconds}s linear`;
                 document.getElementById('timer-bar').style.width = '0%';
            }, 50);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('time-left').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(); 
                }
            }, 1000);
        }

        function manualCheck() {
            if(!isAnswerChecked) {
                clearInterval(timerInterval);
                checkAnswer();
            } else {
                nextQuestion();
            }
        }

        function checkAnswer() {
            if (isAnswerChecked) return;
            isAnswerChecked = true;
            document.getElementById('next-btn').innerText = "ë‹¤ìŒ ë¬¸ì œ >";
            document.getElementById('time-left').innerText = "STOP";
            db.ref('gameStatus').set({ state: 'wait' });

            const q = currentQuizList[currentQIndex];
            const maxPoint = q.point ? parseInt(q.point) : 1000;

            if(q.type !== 'input' && q.type !== 'order' && q.type !== 'ìˆœì„œ') {
                const ansId = `opt-${q.ans}`;
                if(document.getElementById(ansId)) document.getElementById(ansId).classList.add('reveal');
            } else {
                document.getElementById('q-text').innerText += `\n\nâœ… ì •ë‹µ: ${q.ans}`;
            }

            db.ref('answers').once('value', snapshot => {
                const answers = snapshot.val();
                if(!answers) {
                    showLiveRank();
                    return;
                }
                for (const playerId in answers) {
                    const data = answers[playerId];
                    const playerAns = data.answer;
                    const playerTime = data.time || Date.now();
                    let isCorrect = false;

                    // â˜… ì •ë‹µ ì±„ì  ë¡œì§ (ëª¨ë“  ê³µë°± ì œê±° í›„ ë¹„êµ)
                    if(q.type === 'input' || q.type === 'order' || q.type === 'ìˆœì„œ') {
                        if(playerAns && String(playerAns).replace(/\s/g, "") === String(q.ans).replace(/\s/g, "")) isCorrect = true;
                    } else {
                        if(String(playerAns) === String(q.ans)) isCorrect = true;
                    }

                    if(isCorrect) {
                        const timeTaken = (playerTime - questionStartTime) / 1000;
                        let scoreRatio = Math.max(0, (currentTimeLimit - timeTaken) / currentTimeLimit);
                        let earnedPoint = Math.round((maxPoint * 0.5) + ((maxPoint * 0.5) * scoreRatio));
                        db.ref(`players/${playerId}/score`).transaction(currentScore => (currentScore || 0) + earnedPoint);
                    }
                }
                setTimeout(showLiveRank, 800); 
            });
        }

        function showLiveRank() {
            db.ref('players').orderByChild('score').limitToLast(5).once('value', snapshot => {
                const list = [];
                snapshot.forEach(child => list.push(child.val()));
                list.reverse();
                const rankList = document.getElementById('live-rank-list');
                rankList.innerHTML = "";
                if (list.length === 0) {
                    rankList.innerHTML = "<div style='padding:10px; color:#888;'>ë“ì ì ì—†ìŒ</div>";
                } else {
                    list.forEach((p, idx) => {
                        rankList.innerHTML += `
                            <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; font-size:1.2rem;">
                                <span>${idx+1}. ${p.name}</span>
                                <span style="font-weight:bold;">${p.score || 0}ì </span>
                            </div>`;
                    });
                }
                document.getElementById('live-rank-box').style.display = 'block';
                document.getElementById('opt-container').style.display = 'none';
            });
        }

        function finishGame() {
            showScreen('result-screen');
            db.ref('players').orderByChild('score').limitToLast(10).once('value', snapshot => {
                const list = [];
                snapshot.forEach(child => list.push(child.val()));
                list.reverse(); 
                const board = document.getElementById('rank-board');
                board.innerHTML = "";
                list.forEach((p, idx) => {
                    let medal = idx < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][idx] : `${idx+1}ìœ„`;
                    let style = idx === 0 ? 'color:#D4AF37; font-weight:bold; font-size:1.5em;' : '';
                    board.innerHTML += `
                        <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; font-size:1.3rem; ${style}">
                            <span>${medal} ${p.name}</span>
                            <span>${p.score || 0}ì </span>
                        </div>`;
                });
            });
        }

        function resetAllScores() {
            if(confirm("ëª¨ë“  ì°¸ê°€ìì˜ ì ìˆ˜ë¥¼ 0ì ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                db.ref('players').once('value', snap => {
                    const updates = {};
                    snap.forEach(child => { updates[child.key + '/score'] = 0; });
                    db.ref('players').update(updates);
                    db.ref('answers').remove();
                    alert("ì´ˆê¸°í™” ì™„ë£Œ.");
                });
            }
        }
    </script>
</body>
</html>
