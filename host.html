<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>The Grand Quiz - Host</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gb-pink: #F7CAC9; --gb-purple: #5D3A5D; --gb-gold: #D4AF37; --gb-red: #C0392B; }
        body { background-color: var(--gb-pink); color: var(--gb-purple); font-family: 'GmarketSansMedium', sans-serif; margin: 0; text-align: center; display: flex; flex-direction: column; height: 100vh; }
        
        .header { background: var(--gb-purple); color: #fff; padding: 20px; font-size: 2rem; border-bottom: 5px solid var(--gb-gold); display: flex; justify-content: space-between; align-items: center; padding-left: 40px; padding-right: 40px;}
        
        .main { flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; position: relative; }
        .screen { display: none; width: 90%; max-width: 1000px; }
        .active { display: flex; flex-direction: column; align-items: center; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 80%; max-width: 800px; }
        .menu-btn { padding: 40px; background: var(--gb-purple); color: white; border: 4px solid var(--gb-gold); font-size: 1.8rem; cursor: pointer; border-radius: 20px; transition: 0.2s; font-weight: bold; box-shadow: 0 8px 0 #3e263e; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-btn:hover { transform: translateY(-5px); filter: brightness(1.1); }
        .menu-btn.loading { opacity: 0.5; cursor: wait; filter: grayscale(100%); pointer-events: none; }

        .btn-main { background: #5D3A5D; } .btn-consonant { background: #8E44AD; }
        .btn-image { background: #2980B9; } .btn-desc { background: #27AE60; }

        .lobby-container { display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; width: 100%; }
        .qr-section { background: #fff; padding: 20px; border: 4px solid var(--gb-gold); border-radius: 10px; }

        .timer-container { width: 100%; height: 15px; background: #ddd; position: absolute; top: 0; left: 0; }
        .timer-bar { height: 100%; background: var(--gb-red); width: 100%; transition: width 1s linear; }

        .question-box { background: #fff; padding: 30px; border-radius: 10px; border: 3px solid var(--gb-gold); font-size: 2rem; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); word-break: keep-all; font-weight: bold; position: relative; width: 85%; min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; }
        .time-badge { position: absolute; top: -30px; right: -30px; background: var(--gb-purple); color: #fff; width: 80px; height: 80px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; border: 4px solid var(--gb-gold); z-index: 10; }

        .options-display { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 85%; }
        .opt { padding: 25px; color: white; font-size: 1.5rem; border-radius: 15px; opacity: 0.6; transition: 0.3s; font-weight: bold; cursor: pointer; }
        .opt.reveal { opacity: 1; border: 5px solid var(--gb-gold); transform: scale(1.05); box-shadow: 0 0 20px var(--gb-gold); }
        .opt-1 { background: #E74C3C; } .opt-2 { background: #3498DB; } .opt-3 { background: #F1C40F; color: black; } .opt-4 { background: #2ECC71; }

        /* íŒíŠ¸ ë²„íŠ¼ */
        .opt-hint { background: var(--gb-purple); border: 3px solid var(--gb-gold); color: white; font-size: 1.5rem; border-radius: 15px; cursor: pointer; transition: 0.2s; font-weight: bold; padding: 20px; }
        .opt-hint:hover { background: #4a2d4a; transform: scale(1.05); }
        
        /* íŒíŠ¸ í…ìŠ¤íŠ¸ ì˜ì—­ */
        .hint-text-area { margin-top: 20px; font-size: 1.8rem; color: #E67E22; font-weight: bold; background: #fff3e0; padding: 15px; border-radius: 10px; width: 90%; display: none; animation: fadeIn 0.5s; border: 2px dashed #E67E22; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .game-btn { padding: 15px 40px; background: var(--gb-purple); color: white; border: none; font-size: 1.2rem; cursor: pointer; margin-top: 20px; border-radius: 50px; transition: 0.2s; }
        .btn-next { background: #2ECC71; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .round-tag { font-size: 1.2rem; background: #fff; padding: 5px 20px; border-radius: 20px; border: 2px solid var(--gb-gold); color: var(--gb-purple); font-weight: bold; margin-bottom: 10px; }
        
        .rank-popup { display: none; width: 85%; background: #fff; border: 4px solid var(--gb-gold); border-radius: 15px; padding: 15px; margin-top: 20px; animation: slideUp 0.5s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .rank-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 1.3rem; }
        .rank-row:first-child { color: #D4AF37; font-weight: bold; font-size: 1.5rem; }
        .link-text { font-size: 0.8rem; color: #666; margin-top: 5px; word-break: break-all; max-width: 300px; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div>ë°ì´í„° ë¡œë”© ì¤‘...</div></div>

    <div class="header">
        <span>ğŸ¨ The Grand Dev Gala</span>
        <span id="status-text" style="font-size:1rem; background:rgba(0,0,0,0.2); padding:5px 10px; border-radius:15px;">â³ ë¡œë”©ì¤‘...</span>
    </div>

    <div class="main">
        <div id="menu-screen" class="screen active">
            <h1 style="font-size:3rem; margin-bottom:40px;">Select Round</h1>
            <div class="menu-grid">
                <div class="menu-btn btn-main loading" onclick="selectCategory('ë©”ì¸')"><span>ğŸ¨</span><span>ë©”ì¸ í€´ì¦ˆ</span></div>
                <div class="menu-btn btn-consonant loading" onclick="selectCategory('ììŒ')"><span>ğŸ”¤</span><span>ììŒ í€´ì¦ˆ</span></div>
                <div class="menu-btn btn-image loading" onclick="selectCategory('ì´ë¯¸ì§€')"><span>ğŸ”</span><span>ì´ë¯¸ì§€ í™•ëŒ€</span></div>
                <div class="menu-btn btn-desc loading" onclick="selectCategory('ì„¤ëª…')"><span>ğŸ“¢</span><span>ì„¤ëª… í€´ì¦ˆ</span></div>
            </div>
        </div>

        <div id="lobby-screen" class="screen">
            <h1 id="lobby-title" style="font-size:2.5rem; margin-bottom:10px; color:var(--gb-purple);">Check-In</h1>
            <h3 id="lobby-subtitle" style="color:#666; margin-top:0;">ëŒ€ê¸°ì¤‘...</h3>
            <div class="lobby-container">
                <div class="qr-section"><div id="qr-area"></div></div>
                <p class="link-text" id="client-link-display"></p>
                <p style="font-size:1.2rem;">QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì…ì¥í•˜ì„¸ìš”</p>
                <div style="font-size:2rem; color:var(--gb-purple); font-weight:bold;">
                    í˜„ì¬ ì…ì¥: <span id="p-count" style="color:var(--gb-red); font-size:3rem;">0</span>ëª…
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="game-btn" onclick="backToMenu()" style="background:#888;">â¬… ë©”ë‰´</button>
                    <button class="game-btn" onclick="resetScoresKeepPlayers()" style="background:#E67E22;">ğŸ”„ ì ìˆ˜ë§Œ ë¦¬ì…‹</button>
                    <button class="game-btn" onclick="resetAllData()" style="background:var(--gb-red);">âš ï¸ ì™„ì „ ì´ˆê¸°í™”</button>
                </div>
                <button class="game-btn" onclick="startGameReal()" style="font-size:1.5rem; width:100%; max-width:400px;">ê²Œì„ ì‹œì‘ ğŸ¬</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
            <div class="round-tag" id="round-display">Round 1</div>
            <div class="question-box">
                <img id="q-image" src="" style="max-width:100%; max-height:300px; display:none; margin-bottom:15px; border-radius:10px;">
                <span id="q-text" style="white-space: pre-wrap;">ë¬¸ì œ ë¡œë”©ì¤‘...</span>
                
                <!-- íŒíŠ¸ í…ìŠ¤íŠ¸ ì˜ì—­ -->
                <div id="hint-display" class="hint-text-area"></div>

                <div class="time-badge" id="time-left">0</div>
                <div id="q-point-badge" style="font-size:1rem; color:#888; margin-top:15px;">ë°°ì : 1000ì </div>
            </div>
            
            <div class="options-display" id="opt-container"></div>
            
            <div id="live-rank-box" class="rank-popup">
                <h3 style="margin:0 0 10px 0; color:var(--gb-purple);">ğŸ† í˜„ì¬ ìˆœìœ„ (Top 5)</h3>
                <div id="live-rank-list"></div>
            </div>
            <div style="margin-top:15px; font-size:1.2rem; color:#555;">
                ì‘ë‹µ: <span id="ans-count" style="font-weight:bold; color:var(--gb-purple);">0</span>ëª…
            </div>
            <button class="game-btn" id="action-btn" onclick="handleAction()">ì •ë‹µ & ìˆœìœ„ í™•ì¸</button>
        </div>

        <div id="result-screen" class="screen">
            <h1 style="font-size:3rem; color:var(--gb-purple)">ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ ğŸ†</h1>
            <div class="rank-list" id="rank-board" style="width:60%; margin:0 auto; background:#fff; padding:20px; border-radius:10px; border:3px solid var(--gb-gold); max-height:400px; overflow-y:auto;"></div>
            <div style="margin-top:30px; display:flex; gap:20px; justify-content:center;">
                <button class="game-btn" onclick="backToMenu()">ë©”ë‰´ë¡œ (ì ìˆ˜ ìœ ì§€)</button>
                <button class="game-btn" onclick="resetScoreAndMenu()" style="background:#E67E22;">ì ìˆ˜ ì´ˆê¸°í™” & ë©”ë‰´ë¡œ</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAQcP8fknJ_ofom4Nu1-i39j7GLks0OYks",
            authDomain: "thegranddvegala.firebaseapp.com",
            databaseURL: "https://thegranddvegala-default-rtdb.firebaseio.com",
            projectId: "thegranddvegala",
            storageBucket: "thegranddvegala.firebasestorage.app",
            messagingSenderId: "980091305368",
            appId: "1:980091305368:web:e247f9be81e6786888bfed",
            measurementId: "G-8GL8G5NCQF"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const SHEET_URL = "https://script.google.com/macros/s/AKfycbxErU4lp6cRVaK56zFdbZuzD5IvyWfV4S8nyrTmOsjU0pNqR9bQzadoquSCroD8k2wnTg/exec";

        let allQuizData = [], currentQuizList = [], currentQIndex = -1;
        let isRankShown = false, timerInterval = null, questionStartTime = 0, currentTimeLimit = 0;

        let path = window.location.pathname;
        let dir = path.substring(0, path.lastIndexOf('/'));
        const clientURL = window.location.protocol + "//" + window.location.host + dir + "/client.html";
        document.getElementById("client-link-display").innerText = clientURL;
        new QRCode(document.getElementById("qr-area"), { text: clientURL, width: 200, height: 200 });

        window.onload = function() {
            if(!SHEET_URL || SHEET_URL.includes("ì—¬ê¸°ì—")) { alert("ì„¤ì • í™•ì¸ í•„ìš”"); return; }
            fetch(SHEET_URL).then(res => res.json()).then(data => {
                allQuizData = data;
                document.getElementById('status-text').innerText = "âœ… ì¤€ë¹„ ì™„ë£Œ";
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('loading'));
                db.ref('gameStatus').set({ state: 'lobby' }); 
            }).catch(err => { 
                document.getElementById('status-text').innerText = "âŒ ë¡œë”© ì‹¤íŒ¨";
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”)"); 
            });
        };

        db.ref('players').on('value', snap => document.getElementById('p-count').innerText = snap.numChildren());
        db.ref('answers').on('value', snap => document.getElementById('ans-count').innerText = snap.numChildren());

        function selectCategory(keyword) {
            if(allQuizData.length === 0) return alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.");

            const aliases = {
                'ë©”ì¸': ['main', 'ë©”ì¸', 'ê¸°ë³¸'],
                'ììŒ': ['consonant', 'ììŒ', 'ì´ˆì„±', 'initial', 'ã„±ã„´ã„·'],
                'ì´ë¯¸ì§€': ['image', 'ì´ë¯¸ì§€', 'zoom', 'magnify', 'í™•ëŒ€'],
                'ì„¤ëª…': ['desc', 'ì„¤ëª…', 'description', 'hint', 'íŒíŠ¸']
            };
            const targets = aliases[keyword] || [keyword];
            
            currentQuizList = allQuizData.filter(item => {
                const cat = String(item.category || "").toLowerCase();
                return targets.some(t => cat.includes(t));
            });

            if(currentQuizList.length === 0) {
                const loadedCats = [...new Set(allQuizData.map(d => d.category))].join(", ");
                return alert(`"${keyword}" ê´€ë ¨ ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n[í˜„ì¬ ë¡œë“œëœ ì¹´í…Œê³ ë¦¬]\n${loadedCats}`);
            }
            
            document.getElementById('lobby-title').innerText = `${keyword} í€´ì¦ˆ`;
            document.getElementById('lobby-subtitle').innerText = `ì´ ${currentQuizList.length} ë¬¸ì œ`;
            showScreen('lobby-screen');
            db.ref('gameStatus').set({ state: 'lobby' });
        }

        function startGameReal() {
            if(currentQuizList.length === 0) return;
            currentQIndex = -1;
            showScreen('game-screen');
            nextQuestion();
        }

        function backToMenu() { showScreen('menu-screen'); db.ref('gameStatus').set({ state: 'lobby' }); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        function handleAction() {
            if(!isRankShown) { clearInterval(timerInterval); checkAnswerAndShowRank(); }
            else nextQuestion();
        }

        // â˜… í…ìŠ¤íŠ¸ íŒíŠ¸ ë³´ì—¬ì£¼ê¸° (ì„¤ëª… í€´ì¦ˆìš©)
        function showHint(text) {
            const display = document.getElementById('hint-display');
            display.innerText = text;
            display.style.display = 'block';
        }

        // â˜… ì´ë¯¸ì§€ íŒíŠ¸ ë³´ì—¬ì£¼ê¸° (ì´ë¯¸ì§€ í™•ëŒ€ í€´ì¦ˆìš©)
        function changeImage(url) {
            const imgEl = document.getElementById('q-image');
            imgEl.src = url;
            imgEl.style.display = 'block';
        }

        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex >= currentQuizList.length) { finishGame(); return; }
            isRankShown = false;
            const btn = document.getElementById('action-btn'); btn.innerText = "ì •ë‹µ & ìˆœìœ„ í™•ì¸"; btn.className = "game-btn";
            
            const q = currentQuizList[currentQIndex];
            currentTimeLimit = q.time ? parseInt(q.time) : 20;
            const point = q.point ? parseInt(q.point) : 1000;
            document.getElementById('round-display').innerText = `${q.category} - ${q.round || (currentQIndex+1)}`;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('q-point-badge').innerText = `ë°°ì : ${point}ì `;
            
            const imgEl = document.getElementById('q-image');
            imgEl.style.display = (q.image && q.image.startsWith('http')) ? 'block' : 'none';
            if(q.image) imgEl.src = q.image;

            document.getElementById('hint-display').style.display = 'none';
            document.getElementById('ans-count').innerText = "0";
            document.getElementById('live-rank-box').style.display = 'none';
            document.getElementById('opt-container').style.display = 'grid';
            
            const container = document.getElementById('opt-container'); container.innerHTML = '';
            
            let clientType = q.type;
            if(q.type === 'ìˆœì„œ' || q.type === 'order') clientType = 'seq';
            if(q.type === 'ì£¼ê´€ì‹') clientType = 'input';

            // â˜… íŒíŠ¸ í€´ì¦ˆ ë¡œì§ (ì´ë¯¸ì§€ êµì²´ vs í…ìŠ¤íŠ¸ ì¶œë ¥ êµ¬ë¶„)
            const cat = (q.category||'').toLowerCase();
            const isImageQuiz = ['ì´ë¯¸ì§€', 'image', 'zoom', 'í™•ëŒ€'].some(k => cat.includes(k));
            const isDescQuiz = ['ì„¤ëª…', 'desc', 'hint', 'íŒíŠ¸'].some(k => cat.includes(k));
            const hasHints = q.options && q.options.some(o => o && String(o).trim() !== "");

            if ((isImageQuiz || isDescQuiz) && hasHints) {
                q.options.forEach((opt, idx) => {
                    if (opt && String(opt).trim() !== "") {
                        const safeOpt = String(opt).replace(/"/g, '&quot;').replace(/'/g, "\\'");
                        if(isImageQuiz) {
                            // ì´ë¯¸ì§€ í€´ì¦ˆ -> ì´ë¯¸ì§€ êµì²´
                            container.innerHTML += `<button class="opt-hint" onclick="changeImage('${safeOpt}')">ğŸ–¼ï¸ íŒíŠ¸ ${idx+1}</button>`;
                        } else {
                            // ì„¤ëª… í€´ì¦ˆ -> í…ìŠ¤íŠ¸ ì¶œë ¥
                            container.innerHTML += `<button class="opt-hint" onclick="showHint('${safeOpt}')">ğŸ’¡ íŒíŠ¸ ${idx+1}</button>`;
                        }
                    }
                });
                clientType = 'input'; 
            } else if(q.type === 'choice') {
                q.options.forEach((o,i) => container.innerHTML += `<div class="opt opt-${i+1}" id="opt-${i}">${['â–²','â– ','â—','â—†'][i]} ${o}</div>`);
            } else if(q.type === 'ox') {
                container.innerHTML = `<div class="opt opt-1" id="opt-0" style="background:#E74C3C">O</div><div class="opt opt-2" id="opt-1" style="background:#3498DB">X</div>`;
            } else {
                container.style.display = 'none';
                let guide = (clientType === 'seq') ? "ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”" : "ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
                container.innerHTML = `<div style="text-align:center; width:200%; font-size:1.5rem; color:#888; margin-top:20px;">${guide}</div>`;
            }

            db.ref('gameStatus').set({ state: 'play', type: clientType });
            db.ref('answers').remove();
            questionStartTime = Date.now();
            startTimer(currentTimeLimit);
        }

        function startTimer(sec) {
            clearInterval(timerInterval);
            let left = sec;
            document.getElementById('time-left').innerText = left;
            document.getElementById('timer-bar').style.width = '100%';
            document.getElementById('timer-bar').style.transition = `width ${sec}s linear`;
            setTimeout(() => document.getElementById('timer-bar').style.width = '0%', 50);
            timerInterval = setInterval(() => {
                left--; document.getElementById('time-left').innerText = left;
                if(left <= 0) { clearInterval(timerInterval); checkAnswerAndShowRank(); }
            }, 1000);
        }

        function checkAnswerAndShowRank() {
            if(isRankShown) return; isRankShown = true;
            const btn = document.getElementById('action-btn'); btn.innerText = "ë‹¤ìŒ ë¬¸ì œ >"; btn.classList.add('btn-next');
            document.getElementById('time-left').innerText = "STOP";
            
            const q = currentQuizList[currentQIndex];
            db.ref('gameStatus').set({ state: 'result', answer: q.ans });

            const maxPoint = q.point ? parseInt(q.point) : 1000;

            // íŒíŠ¸ í€´ì¦ˆë„ ì—¬ê¸°ì„œ ì²˜ë¦¬ (ë‹µ ê³µê°œ)
            if(q.type !== 'input' && q.type !== 'order' && q.type !== 'ìˆœì„œ' && q.type !== 'seq' && document.getElementsByClassName('opt-hint').length === 0) {
                const ansId = `opt-${q.ans}`;
                if(document.getElementById(ansId)) document.getElementById(ansId).classList.add('reveal');
            } else document.getElementById('q-text').innerText += `\n\nâœ… ì •ë‹µ: ${q.ans}`;

            db.ref('answers').once('value', ansSnap => {
                const answers = ansSnap.val();
                db.ref('players').once('value', pSnap => {
                    const updates = {};
                    pSnap.forEach(p => {
                        const pid = p.key, pData = p.val();
                        let score = pData.score || 0, isCorrect = false, earned = 0;
                        if(answers && answers[pid]) {
                            const ans = answers[pid];
                            // íŒíŠ¸ í€´ì¦ˆ í¬í•¨ í…ìŠ¤íŠ¸ ë¹„êµ
                            if(['input','order','ìˆœì„œ','seq'].includes(q.type) || q.type === 'text' || document.getElementsByClassName('opt-hint').length > 0) {
                                if(ans.answer && String(ans.answer).replace(/\s/g,"") === String(q.ans).replace(/\s/g,"")) isCorrect = true;
                            } else if(String(ans.answer) === String(q.ans)) isCorrect = true;
                            
                            if(isCorrect) {
                                const ratio = Math.max(0, (currentTimeLimit - (ans.time - questionStartTime)/1000) / currentTimeLimit);
                                earned = Math.round((maxPoint*0.5) + (maxPoint*0.5)*ratio);
                                score += earned;
                            }
                        }
                        updates[`players/${pid}/score`] = score;
                        updates[`players/${pid}/lastResult`] = { isCorrect: isCorrect, earned: earned, total: score };
                    });
                    db.ref().update(updates).then(() => setTimeout(displayRankBox, 500));
                });
            });
        }

        function displayRankBox() {
            db.ref('players').orderByChild('score').limitToLast(5).once('value', snap => {
                const list = []; snap.forEach(c => list.push(c.val())); list.reverse();
                const rankList = document.getElementById('live-rank-list'); rankList.innerHTML = "";
                if(list.length === 0) rankList.innerHTML = "<div style='padding:10px;'>ë“ì ì ì—†ìŒ</div>";
                else list.forEach((p, i) => rankList.innerHTML += `<div class="rank-row"><span>${i+1}. ${p.name}</span><span>${p.score||0}ì </span></div>`);
                document.getElementById('live-rank-box').style.display = 'block';
                document.getElementById('opt-container').style.display = 'none';
            });
        }

        function finishGame() {
            showScreen('result-screen');
            db.ref('players').orderByChild('score').limitToLast(10).once('value', snap => {
                const list = []; snap.forEach(c => list.push(c.val())); list.reverse();
                const board = document.getElementById('rank-board'); board.innerHTML = "";
                list.forEach((p, i) => {
                    let style = i===0 ? 'color:#D4AF37; font-weight:bold;' : '';
                    board.innerHTML += `<div class="rank-row" style="${style}"><span>${i+1}ìœ„ ${p.name}</span><span>${p.score||0}ì </span></div>`;
                });
            });
        }

        function resetScoresKeepPlayers() {
            if(confirm("ì°¸ê°€ì ìœ ì§€, ì ìˆ˜ë§Œ 0ì ?")) {
                db.ref('players').once('value', s => {
                    if(s.exists()) { const u={}; s.forEach(c=>u[`players/${c.key}/score`]=0); db.ref().update(u); }
                    db.ref('answers').remove(); alert("ì™„ë£Œ");
                });
            }
        }
        function resetAllData() { if(confirm("ì „ì²´ ì‚­ì œ?")) { db.ref('players').remove(); db.ref('answers').remove(); alert("ì™„ë£Œ"); } }
        function resetScoreAndMenu() { resetScoresKeepPlayers(); backToMenu(); }
    </script>
</body>
</html>
